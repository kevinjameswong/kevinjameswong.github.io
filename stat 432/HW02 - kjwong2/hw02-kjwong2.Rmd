---
title: "STAT 432 - Homework 02"
author: "Kevin Wong - kjwong2"
date: '**Due:** Friday, February 9, 11:59 PM'
---

***

Please see the [homework policy document](https://daviddalpiaz.github.io/stat432sp18/homework_policy.html) for detailed instructions and some grading notes. Failure to follow instructions will result in point reductions.

***

> Hofstadter's Law: "It always takes longer than you expect, even when you take into account Hofstadter's Law."
>
> --- **Douglas Hofstadter**, GÃ¶del, Escher, Bach: An Eternal Golden Braid

***

For this homework we will use the `Sacramento` data from the `caret` package. You should read the documentation for this data. The **goal** of our modeling will be to predict home prices.

You may only use the following packages:

```{r, message = FALSE, warning = FALSE}
library(caret)
library(randomForest)
library(tidyverse)
library(knitr)
library(kableExtra)
```

Before modeling, we will perform some data preparation.

Instead of using the `city` or `zip` variables that exist in the dataset, we will simply create a variable indicating whether or not a house is technically within the city limits Sacramento. (We do this because they would both be factor variables with a large number of factors. This is a choice that is made due to laziness, not because it is justified. Think about what issues these variables might cause.)

```{r}
data(Sacramento)
sac_data = Sacramento
sac_data$limits = factor(ifelse(sac_data$city == "SACRAMENTO", "in", "out"))
sac_data = subset(sac_data, select = -c(city, zip))
```

A plot of longitude versus latitude gives us a sense of where the city limits are.

```{r, fig.align = "center"}
qplot(y = longitude, x = latitude, data = sac_data, 
      col = limits, main = "Sacramento City Limits ")
```

You should consider performing some additional [exploratory data analysis](https://en.wikipedia.org/wiki/Exploratory_data_analysis), but we provide a histogram of the home prices.

```{r fig.align = "center", message = FALSE, warning = FALSE}
qplot(x = price, data = sac_data, main = "Sacramento Home Prices")
```

After these modifications, we test-train split the data.

```{r}
set.seed(42)
sac_trn_idx  = sample(nrow(sac_data), size = trunc(0.80 * nrow(sac_data)))
sac_trn_data = sac_data[sac_trn_idx, ]
sac_tst_data = sac_data[-sac_trn_idx, ]
```

The training data should be used for all model fitting.

***

## Exercise 1 (Modeling Price, Without Location)

For this exercise, we will create linear models in an attempt to be able to predict `price`, **without** the use of the `limtis`, `latitude`, or `longitude` variables. Do not modify `sac_trn_data`.

With the available variables, fit the following models:

- An additive model using all *availible* predictors
- A model using *only* `sqft` as a predictor
- $\texttt{price} = \beta_0 + \beta_1 \texttt{sqft} + \beta_2 \texttt{multi} + \beta_3 \texttt{res} + \epsilon$
- $\texttt{price} = \beta_0 + \beta_1 \texttt{sqft} + \beta_2 \texttt{multi} + \beta_3 \texttt{res} + \beta_4 (\texttt{sqrt}\times\texttt{multi}) + \beta_5 (\texttt{sqrt}\times\texttt{res}) + \epsilon$

Here, `res` is a dummy variable indicating whether or not `type` is `Residential`. Similarly, `multi` is a dummy variables indicating whether or not `type` is `Multi_Family`.

Summarize these models using a well-formatted markdown table which includes columns for:

- Model (written using `R`'s formula syntax)
- Train RMSE
- Test RMSE

**Solution:**
```{r}
sac_mod_1 = lm(price ~ . - limits - latitude - longitude, data = sac_trn_data)
sac_mod_2 = lm(price ~ sqft, data = sac_trn_data)
sac_mod_3 = lm(price ~ sqft + type, data = sac_trn_data)
sac_mod_4 = lm(price ~ sqft * type, data = sac_trn_data)
```

```{r}
calc_rmse = function(mod, actual, data) {
  predicted = predict(mod, data)
  sqrt(mean((actual - predicted) ^ 2))
}

mod_ex1_list = list(sac_mod_1, sac_mod_2, sac_mod_3, sac_mod_4)
sac_ex1_trn_rmse = sapply(mod_ex1_list, actual = sac_trn_data$price, calc_rmse, data = sac_trn_data)
sac_ex1_tst_rmse = sapply(mod_ex1_list, actual = sac_tst_data$price, calc_rmse, data = sac_tst_data)
```

```{r}
sac_ex1_results = data.frame(
  Model_names_ex1 = c("sac_mod_1", "sac_mod_2", "sac_mod_3", "sac_mod_4"),
  trn_rmse_ex1 = sac_ex1_trn_rmse,
  tst_rmse_ex1 = sac_ex1_tst_rmse
)
colnames(sac_ex1_results) = c("Model Name", "Training RMSE", "Testing RMSE")

kable_styling(kable(sac_ex1_results, format = "html", digits = 3), full_width = FALSE)
```

***

## Exercise 2 (Modeling Price, With Location)

For this exercise, we will create models in an attempt to be able to predict `price`, using all available predictors.

Fit a total of four models:

- **`add`**: an *additive* linear model using all *availible* predictors
- **`int`**: a linear model using all the main effects of all *availible* predictors as well, as all possible two-way *interactions*
- **`user`**: a linear model that performs better than **`add`** and **`int`**
- **`rf`**: a *random forest* which uses all available predictors fit using the `randomForest()` function from the `randomForest` package with all default arguments. To specify the predictors used, use the formula syntax for an additive model

Summarize these models using a well-formatted markdown table which includes columns for:

- Model Name
- Model Type (`lm` or `rf`)
- Variables Used (may use formula syntax)
- Train RMSE
- Test RMSE

**Solution:**
```{r}
sac_mod_add = lm(price ~ ., data = sac_trn_data)
sac_mod_int = lm(price ~ . ^ 2, data = sac_trn_data)
sac_mod_user = lm(price ~ sqft + type + limits + latitude + longitude + beds, data = sac_trn_data)
sac_mod_rf = randomForest(price ~ ., data = sac_trn_data)
```

```{r}
mod_ex2_list = list(sac_mod_add, sac_mod_int, sac_mod_user, sac_mod_rf)
sac_ex2_trn_rmse = sapply(mod_ex2_list, actual = sac_trn_data$price, calc_rmse, data = sac_trn_data)
sac_ex2_tst_rmse = sapply(mod_ex2_list, actual = sac_tst_data$price, calc_rmse, data = sac_tst_data)
```

```{r}
sac_ex2_results = data.frame(
  Model_names_ex2 = c("sac_mod_add", "sac_mod_int", "sac_mod_user", "sac_mod_rf"),
  Model_type_ex2 = c("lm", "lm", "lm", "rf"),
  Vars_used_ex2 = c("`price ~ .`", "`price ~ . ^ 2`", "`price ~ sqft + type + limits + latitude + longitude + beds`", "`price ~ .`"),
  trn_rmse_ex2 = sac_ex2_trn_rmse,
  tst_rmse_ex2 = sac_ex2_tst_rmse
)
colnames(sac_ex2_results) = c("Model Name", "Model Type", "Variables Used", "Training RMSE", "Testing RMSE")

kable_styling(kable(sac_ex2_results, format = "html", digits = 3), full_width = FALSE)
```

***

## Exercise 3 (Modeling Price, Response Transformation)

Re-fit each of the models from Exercise 2, but with a log transformation applied to the response. (**Do not modify the data to do so.**)

Summarize the results of these four models using a well-formatted markdown table which includes columns for:

- Mode Name (append **log_** to the start of the previous names)
- Model Type (`lm` or `rf`)
- Variables Used (may use formula syntax)
- Train RMSE (on the data scale, that is, units of **dollars**)
- Test RMSE (on the data scale, that is, units of **dollars**)

**Solution:**
```{r}
log_sac_mod_add = lm(log(price) ~ ., data = sac_trn_data)
log_sac_mod_int = lm(log(price) ~ . ^ 2, data = sac_trn_data)
log_sac_mod_user = lm(log(price) ~ sqft + type + limits + latitude + longitude + beds, data = sac_trn_data)
log_sac_mod_rf = randomForest(log(price) ~ ., data = sac_trn_data)
```

```{r}
calc_log_rmse = function(mod, actual, data) {
  predicted = predict(mod, data)
  sqrt(mean((actual - exp(predicted)) ^ 2))
}
```

```{r}
mod_ex3_list = list(log_sac_mod_add, log_sac_mod_int, log_sac_mod_user, log_sac_mod_rf)
sac_ex3_trn_rmse = sapply(mod_ex3_list, actual = sac_trn_data$price, calc_log_rmse, data = sac_trn_data)
sac_ex3_tst_rmse = sapply(mod_ex3_list, actual = sac_tst_data$price, calc_log_rmse, data = sac_tst_data)
```

```{r}
sac_ex3_results = data.frame(
  Model_names_ex3 = c("log_sac_mod_add", "log_sac_mod_int", "log_sac_mod_user", "log_sac_mod_rf"),
  Model_type = c("`lm`", "`lm`", "`lm`", "`rf`"),
  Vars_used_ex3 = c("`log(price) ~ .`", "`log(price) ~ . ^ 2`", "`log(price) ~ sqft + type + limits + latitude + longitude + beds`", "`log(price) ~ .`"),
  trn_rmse_ex3 = sac_ex3_trn_rmse,
  tst_rmse_ex3 = sac_ex3_tst_rmse
)
colnames(sac_ex3_results) = c("Model Name", "Model Type", "Variables Used", "Training RMSE", "Testing RMSE")

kable_styling(kable(sac_ex3_results, format = "html", digits = 3), full_width = FALSE)
```

***

## Exercise 4 (Concept Checks)

**[a]** Which model in Exercise 1 performs best?

**Solution:**
Model 1, the additive model `lm(price ~ .)`

**[b]** Which model in Exercise 2 performs best?

**Solution:**
Model 4, the Random Forest `randomForest(price ~ .)`

**[c]** Which model in Exercise 3 performs best?

**Solution:**
Model 4, the Random Forest `randomForest(log(price) ~ .)`

**[d]** Does the log transformation appear justified? Explain.

**Solution:**
No. The training RMSE and testing RMSE increases for all four models after the log transformation.

**[e]** Does location appear to be helpful for predicting price? Explain.

**Solution:**
```{r}
mod1 = lm(price ~ . - longitude - latitude, data = sac_trn_data)
mod2 = lm(price ~ ., data = sac_trn_data)
anova(mod1, mod2)
```
Yes. If you run summary(mod2), `Longitude` and `Latitude` are both significant predictors at the $\alpha$ = 5% level. According to anova, the model is statistically significantly better with longitude and latitude in the model, so yes, location is helpful for predicting price.

**[f]** Suggest a reason for performing this **analysis**. The reason we are creating the **models** is to predict price. From an analysis perspective, why might these predictions be useful?

**Solution:**
If you are shopping for a house, it would be very helpful to know the price of a theoretically similar house. Using this housing model, we can predict prices of homes with various sqft, locations, beds, baths, etc. Lastly, it is important to know which features of the most are most influential to the price of the house.

**[g]** With your answer to part **[f]** in mind, is the best model we found at all useful? Explain.

**Solution:**
Our best model with the lowest RMSE values was the Model 4 of Exercise 2 (sac_mod_rf). It was the random Forest model that used all of the predictors available. Although it was a good model, there are similar models with less predictors that have similar RMSEs. With that said, we can say that many of the variables were not significant to predicting the price of a house.
